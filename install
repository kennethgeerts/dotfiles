#!/usr/bin/env zsh

set -e

DOTFILES_DIR="$HOME/.dotfiles"
mkdir -p "$HOME/.config" "$HOME/.local/bin"

echo "📱 Installing Xcode command line tools..."
xcode-select --install

echo "🖥️  Setting up system hostname..."
read -r "HOSTNAME?Enter hostname: " || HOSTNAME="sofuto"
if [[ -z "$HOSTNAME" ]]; then
  HOSTNAME="sofuto"
fi

echo "🔐 Please enter your password:"
sudo -v

echo "🔧 Setting up macOS system preferences..."
sudo scutil --set ComputerName $HOSTNAME
sudo scutil --set HostName $HOSTNAME
sudo scutil --set LocalHostName $HOSTNAME
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string $HOSTNAME

echo "⌨️  Configuring keyboard settings..."
defaults write -g InitialKeyRepeat -int 10
defaults write -g KeyRepeat -int 1

echo "📦 Cloning dotfiles repository..."
git clone https://github.com/kennethgeerts/dotfiles.git "$DOTFILES_DIR"

cd "$DOTFILES_DIR"
echo "🍺 Installing Homebrew..."
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
eval "$(/opt/homebrew/bin/brew shellenv)"

echo "⏳ Installing packages (this may take a while)..."
brew bundle --verbose

echo "🐚 Setting up Prezto..."
git clone --recursive https://github.com/sorin-ionescu/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"
setopt EXTENDED_GLOB
for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
  ln -s "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}"
done

echo "🔗 Creating configuration file symlinks..."
for file in prompt.omp.json gemrc gitconfig gitignore railsrc zpreztorc zshrc; do
  rm -f "$HOME/.$file"
  ln -s "$DOTFILES_DIR/$file" "$HOME/.$file"
done

echo "📁 Creating configuration directory symlinks..."
for dir in kitty ghostty bat nvim; do
  ln -s "$DOTFILES_DIR/$dir" "$HOME/.config/$dir"
done

echo "🛠️  Linking custom scripts..."
for bin in solar.sh mac-update vimv; do
  ln -s "$DOTFILES_DIR/bin/$bin" "$HOME/.local/bin/$bin"
done

echo "📝 Setting up nvim..."
nvim --headless "+Lazy! sync" +qa

echo "💎 Installing Ruby..."
mise use -g ruby
mise settings add idiomatic_version_file_enable_tools ruby

source ~/.zshrc

echo ""
echo "🎉 Installation complete!"
