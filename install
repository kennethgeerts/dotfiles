#!/usr/bin/env zsh

set -e

echo "ğŸ” Please enter your password:"
sudo -v

echo "ğŸ–¥ï¸  Setting up system hostname..."
HOSTNAME="sofuto"
sudo scutil --set ComputerName "$HOSTNAME"
sudo scutil --set HostName "$HOSTNAME"
sudo scutil --set LocalHostName "$HOSTNAME"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "$HOSTNAME"

echo "âŒ¨ï¸  Configuring keyboard settings..."
defaults write -g InitialKeyRepeat -int 10
defaults write -g KeyRepeat -int 1

echo "ğŸ“± Installing Xcode command line tools..."
if ! xcode-select -p &>/dev/null; then
  xcode-select --install
  echo "â³ Waiting for Xcode command line tools installation to complete..."
  while ! xcode-select -p &>/dev/null; do
    sleep 5
  done
  echo "âœ… Xcode command line tools installation complete!"
else
  echo "âœ… Xcode command line tools already installed"
fi

echo "ğŸ“¦ Cloning dotfiles repository..."
if [[ ! -d "$HOME/.dotfiles" ]]; then
  git clone https://github.com/kennethgeerts/dotfiles.git "$HOME/.dotfiles"
else
  echo "âœ… Dotfiles repository already exists, skipping clone"
fi

cd "$HOME/.dotfiles"
echo "ğŸº Installing Homebrew..."
if ! command -v brew &>/dev/null; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
eval "$(/opt/homebrew/bin/brew shellenv)"

echo "â³ Installing packages (this may take a while)..."
brew bundle --verbose

echo "ğŸ”— Creating configuration file symlinks..."
for file in "$HOME/.dotfiles/home"/*(ND); do
  if [[ -f "$file" ]]; then
    filename=$(basename "$file")
    rm -f "$HOME/$filename"
    ln -s "$file" "$HOME/$filename"
  fi
done

echo "ğŸ“ Creating configuration directory symlinks..."
mkdir -p "$HOME/.config"
for dir in "$HOME/.dotfiles/config"/*(ND); do
  if [[ -d "$dir" ]]; then
    dirname=$(basename "$dir")
    rm -f "$HOME/.config/$dirname"
    ln -s "$dir" "$HOME/.config/$dirname"
  fi
done

echo "ğŸ› ï¸  Linking custom scripts..."
mkdir -p "$HOME/.local/bin"
for bin in "$HOME/.dotfiles/bin"/*(ND); do
  if [[ -f "$bin" ]]; then
    binname=$(basename "$bin")
    rm -f "$HOME/.local/bin/$binname"
    ln -s "$bin" "$HOME/.local/bin/$binname"
  fi
done

echo "ğŸ“ Setting up nvim..."
rm -rf "$HOME/.config/nvim"
git clone https://github.com/LazyVim/starter "$HOME/.config/nvim"
rm -rf "$HOME/.config/nvim/.git"
rm -rf "$HOME/.config/nvim/lua/plugins"
ln -s "$HOME/.dotfiles/nvim/lua/plugins" "$HOME/.config/nvim/lua/plugins"
nvim --headless "+Lazy! sync" +qa

echo "ğŸ’ Setting up Mise..."
mise use -g ruby
mise use -g node
mise settings add idiomatic_version_file_enable_tools ruby
mise settings add idiomatic_version_file_enable_tools node

echo "ğŸ”„ Reloading shell configuration..."
source ~/.zshrc || true

echo ""
echo "ğŸ‰ Installation complete!"
