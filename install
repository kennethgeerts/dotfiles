#!/usr/bin/env zsh

set -e

DOTFILES_DIR="$HOME/.dotfiles"
CONFIG_DIR="$HOME/.config"
LOCAL_BIN_DIR="$HOME/.local/bin"
mkdir -p "$CONFIG_DIR" "$LOCAL_BIN_DIR"

echo "ğŸ“± Installing Xcode command line tools..."
xcode-select --install

echo "ğŸ–¥ï¸  Setting up system hostname..."
read -r "HOSTNAME?Enter hostname: " || HOSTNAME="sofuto"
if [[ -z "$HOSTNAME" ]]; then
  HOSTNAME="sofuto"
fi

echo "ğŸ” Please enter your password:"
sudo -v

echo "ğŸ”§ Setting up macOS system preferences..."
sudo scutil --set ComputerName $HOSTNAME
sudo scutil --set HostName $HOSTNAME
sudo scutil --set LocalHostName $HOSTNAME
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string $HOSTNAME

echo "âŒ¨ï¸  Configuring keyboard settings..."
defaults write -g InitialKeyRepeat -int 10
defaults write -g KeyRepeat -int 1

echo "ğŸ“¦ Cloning dotfiles repository..."
git clone https://github.com/kennethgeerts/dotfiles.git "$DOTFILES_DIR"

cd "$DOTFILES_DIR"
echo "ğŸº Installing Homebrew..."
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
eval "$(/opt/homebrew/bin/brew shellenv)"

echo "â³ Installing packages (this may take a while)..."
brew bundle --verbose

echo "ğŸš Setting up zsh..."
mkdir -p ~/.zsh
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.zsh/zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-autosuggestions.git ~/.zsh/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-completions.git ~/.zsh/zsh-completions
git clone https://github.com/zsh-users/zsh-history-substring-search.git ~/.zsh/zsh-history-substring-search
git clone https://github.com/joshskidmore/zsh-fzf-history-search.git ~/.zsh/zsh-fzf-history-search
git clone https://github.com/MichaelAquilina/zsh-you-should-use.git ~/.zsh/zsh-you-should-use

echo "ğŸ”— Creating configuration file symlinks..."
for file in prompt.omp.json gemrc gitconfig gitignore railsrc zshrc; do
  rm -f "$HOME/.$file"
  ln -s "$DOTFILES_DIR/home/$file" "$HOME/.$file"
done

echo "ğŸ“ Creating configuration directory symlinks..."
for dir in kitty ghostty bat; do
  ln -s "$DOTFILES_DIR/config/$dir" "$CONFIG_DIR/$dir"
done

echo "ğŸ› ï¸  Linking custom scripts..."
for bin in solar.sh mac-update vimv; do
  ln -s "$DOTFILES_DIR/bin/$bin" "$LOCAL_BIN_DIR/$bin"
done

echo "ğŸ“ Setting up nvim..."
git clone https://github.com/LazyVim/starter "$CONFIG_DIR/nvim"
rm -rf "$CONFIG_DIR/nvim/.git"
rm -rf "$CONFIG_DIR/nvim/lua/plugins"
ln -s "$DOTFILES_DIR/config/nvim/lua/plugins" "$CONFIG_DIR/nvim/lua/plugins"
nvim --headless "+Lazy! sync" +qa

echo "ğŸ’ Setting up Mise..."
mise use -g ruby
mise use -g node
mise settings add idiomatic_version_file_enable_tools ruby
mise settings add idiomatic_version_file_enable_tools node

source ~/.zshrc

echo ""
echo "ğŸ‰ Installation complete!"
